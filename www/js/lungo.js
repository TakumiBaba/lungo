// Generated by CoffeeScript 1.6.3
(function() {
  var generateContent, generateLi, generatePage, linda, reloadList, ts,
    _this = this;

  linda = new Linda();

  ts = new linda.TupleSpace("stock");

  linda.io.on("connect", function() {
    return ts.read([], function(tuple) {
      reloadList(tuple);
      return ts.watch([], reloadList);
    });
  });

  reloadList = function(tuple) {
    var key, li, page, ul, value, _ref;
    ul = $("#list");
    ul.empty();
    _ref = tuple[0];
    for (key in _ref) {
      value = _ref[key];
      console.log(key, value.stock);
      if (value.stock > 0) {
        continue;
      }
      li = generateLi(key, value);
      ul.append(li);
      page = generatePage(key, value);
      $("#" + key).remove();
      $("body").prepend(page);
    }
    return ul.listview("refresh");
  };

  generateLi = function(key, value) {
    var a, li, name;
    name = "";
    if (value.name === "") {
      name = key;
    } else {
      name = value.name;
    }
    li = $("<li></li>").attr("data-theme", "c");
    a = $("<a>").attr("href", "#" + key).attr("data-transition", 'slide').html(name);
    li.append(a);
    return li;
  };

  generatePage = function(key, value) {
    var backButton, content, h3, header, page;
    page = $("<div>").attr("id", key).attr("data-role", "page");
    header = $("<div>").attr("data-role", "header").attr("data-theme", "a");
    backButton = $("<a>").attr("data-icon", "delete").attr("data-rel", "back").attr("data-direction", "reverse").html("戻る");
    h3 = $("<h3>").html("ざいこ");
    content = generateContent(key, value);
    header.append(backButton);
    header.append(h3);
    page.append(header);
    page.append(content);
    return page;
  };

  generateContent = function(key, value) {
    var button, content, form, name, nameInput;
    content = $("<div>").attr("data-role", "content");
    form = $("<form>");
    nameInput = $("<input>").attr("type", "text").val(value.name);
    form.append(nameInput);
    name = value.name;
    button = $("<a>").attr("data-role", "button").html("買った！").attr("data-rel", "back").attr("data-direction", "reverse");
    content.append(form);
    content.append(button);
    button.bind("click", function() {
      return ts.take([], function(tuple) {
        var v;
        console.log(tuple[0]);
        v = tuple[0];
        v[key].stock = 10;
        v[key].name = name;
        return ts.write([v]);
      });
    });
    nameInput.bind("blur", function(e) {
      console.log(e);
      return ts.take([], function(tuple) {
        var v;
        v = tuple[0];
        v[key].name = nameInput.val();
        ts.write([v]);
        return location.href = "./index.html";
      });
    });
    return content;
  };

}).call(this);
